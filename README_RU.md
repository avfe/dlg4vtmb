# Visual VTMB DLG Editor — Руководство (RU)

Интерактивный редактор диалогов формата **DLG** (совместим с VTMB). Программа визуализирует диалоги как **граф**:
- **Синие** стрелки — связи **PC → NPC** (ответ игрока ведёт к реплике NPC)
- **Зелёные** стрелки — **NPC → PC** (варианты ответов игрока от данного NPC)

## Возможности
- **Деревья диалогов**: древовидная раскладка (вертикальная / горизонтальная)
- **Автокомпоновка больших графов**: компоненты автоматически пакуются в **сетку**, без «бесконечной ширины»
- **Быстрое добавление ответа**: «Add NPC answer…» сразу рисует стрелку **PC → новый NPC** до открытия редактора ноды
- **Подсветка контекста**: при выборе ноды подсвечиваются **все** её входящие и исходящие стрелки (и синие, и зелёные)
- **Навигация стрелками**:
  - Вертикальная ориентация: **↑** — ко входящим; **↓** — к исходящим; **← / →** — переход по детям/сиблингам
  - Горизонтальная ориентация: **←** — ко входящим; **→** — к исходящим
- **Масштаб и панорама**: колесо, Pinch, «рука» (Space/средняя кнопка), «Fit to graph/width/height»
- **Автосохранение** каждые 60 секунд (recovery-файл)
- Импорт/экспорт: **DLG**, **JSON**

## Установка и запуск

### Зависимости
- **Python** 3.9+ (рекомендуется 3.10–3.12)
- **PyQt5** ≥ 5.15

На Linux могут понадобиться системные библиотеки X11/Qt (обычно подтягиваются колесом PyQt5). Примеры для Debian/Ubuntu: `libxcb-xinerama0`, `libxkbcommon-x11-0` и т.п.

### Установка
```bash
git clone <repo-url> dlg4vtmb
cd dlg4vtmb

python -m venv .venv
# Windows: .venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate

pip install -U pip
pip install PyQt5
```

### Запуск
```bash
python app.py
```

## Быстрый тур

- **Открыть файл**: `File → Open DLG…` или `Open JSON…`
- **Сохранить/Экспорт**: `Save DLG…` / `Export JSON…`
- **Добавить узел**: `Add Node…` (или контекстное меню ноды)
- **Add NPC answer…** (ПКМ по PC-ноде) — сразу появляется стрелка **PC → NPC**, затем открывается редактор ноды
- **Раскладки**: `Layout: Tree (Vertical / Horizontal)` и `Layout: Sugiyama`
- **Автокомпакт**: `Auto Compact` — подбирает зазоры
- **Отступы**: `Format Spacing…` (+ горячие `Ctrl+[`, `Ctrl+]`)
- **Опционные (зелёные) рёбра**: `View → Show NPC → PC links` (вкл/выкл)
- **Пустые ноды**: `View → Show Empty Nodes` (вкл/выкл)
- **Подсветка**: клик по ноде подсвечивает **все** входящие/исходящие (синие/зелёные) стрелки данной ноды
- **Навигация стрелками**:
  - Вертикаль: **↑** входящие, **↓** исходящие, **←/→** — дети/сиблинги
  - Горизонталь: **←** входящие, **→** исходящие
- **Масштаб/панорама**: колесо, Pinch, **Space** — режим «руки», **средняя кнопка** — панорама
- **Фокусировка**: `Fit to Graph (F)`, `Fit Width`, `Fit Height`

## Горячие клавиши (основные)
- **Поиск**: `Ctrl+F`
- **Undo/Redo**: `Ctrl+Z`, `Ctrl+Y` (`Ctrl+Shift+Z`)
- **Копировать/Вставить/Вырезать/Удалить**: `Ctrl+C`, `Ctrl+V`, `Ctrl+X`, `Del`
- **Добавить ноду**: `Ctrl+N` (NPC: `Ctrl+Shift+N`, PC: `Ctrl+Shift+P`)
- **Трассировка к корням**: `T`
- **Зум**: `Ctrl+=`, `Ctrl+-`, сброс — `Ctrl+0`
- **Вписать граф**: `F`
- **Автокомпакт**: `Ctrl+Shift+F`
- **Сужение/расширение зазоров**: `Ctrl+[`, `Ctrl+]`
- **Навигация**: стрелки

(*Фактический набор может меняться — ориентируйтесь на меню текущей сборки.*)

## Где хранится автосейв
`<AppData>/dlg4vtmb/autosave.json` — путь зависит от ОС/пользователя (`QStandardPaths.AppDataLocation`).

## Структура исходников
- `app.py` — точка входа
- `mainwindow.py` — главное окно, сценография, подсветка, навигация, действия/меню
- `graphview.py` — `GraphView`, `GraphNode`, `GraphEdge`, `OptionEdge`
- `layout.py` — раскладки (дерево, сеточная упаковка), барицентрическое упорядочивание
- `model.py` — `DlgRow` (данные диалога)
- `io_dlg.py` — чтение/запись `.dlg`
- `json_conv.py` — импорт/экспорт JSON

## Советы для больших файлов
- Запусти **Auto Compact** и/или настрой зазоры в **Format Spacing…**
- Новая сеточная компоновка для деревьев решает проблему «бесконечной ширины»
- Если зелёные рёбра мешают, временно отключи `Show NPC → PC links`
